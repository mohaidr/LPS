syntax = "proto3";

option csharp_namespace = "LPS.Protos.Shared";

package metrics;

// Common types
message HttpMetricMetadata {
  string roundName = 1;
  string iterationId = 2;
  string iterationName = 3;
  string httpMethod = 4;
  string url = 5;
  string httpVersion = 6;
}

// Filter combination mode
enum FilterMode {
  AND = 0;
  OR = 1;
}

// Extended and Unified Request
message MetricRequest {
  string fullyQualifiedName = 1;
  string roundName = 2;
  string iterationId = 3;
  string iterationName = 4;
  string httpMethod = 5;
  string hostname = 6;
  string path = 7;
  string httpVersion = 8;
  FilterMode mode = 9;
}

message RequestsRate {
  string every = 1; // e.g., "1s", "cooldown-period"
  double value = 2; // number of requests per that interval
}

message HttpResponseSummary {
  string httpStatusCode = 1;
  string httpStatusReason = 2;
  int32 count = 3;
}

// Timing metric stats - reusable for all timing types
message TimingMetricStats {
  double sum = 1;
  double average = 2;
  double min = 3;
  double max = 4;
  double p50 = 5;
  double p90 = 6;
  double p95 = 7;
  double p99 = 8;
}

// Duration Metric - comprehensive timing stats for all metric types
message DurationMetricResponse {
  HttpMetricMetadata metadata = 1;
  
  // Reserved field numbers 2-8 (previously legacy fields, now removed)
  reserved 2, 3, 4, 5, 6, 7, 8;
  
  // Comprehensive timing stats for all metric types
  TimingMetricStats totalTime = 10;
  TimingMetricStats timeToFirstByte = 11;      // TTFB
  TimingMetricStats waitingTime = 12;          // Server processing: TTFB - TCP - TLS
  TimingMetricStats tcpHandshakeTime = 13;     // TCP connection setup
  TimingMetricStats tlsHandshakeTime = 14;     // SSL/TLS negotiation
  TimingMetricStats sendingTime = 15;          // Request upload time
  TimingMetricStats receivingTime = 16;        // Response download time
}

message DurationMetricSearchResponse {
  repeated DurationMetricResponse responses = 1;
}

// Data Transmission Metric
message DataTransmissionMetricResponse {
  HttpMetricMetadata metadata = 1;
  double totalDataTransmissionTimeInMilliseconds = 2;
  double dataSent = 3;
  double dataReceived = 4;
  double averageDataSent = 5;
  double averageDataReceived = 6;
  double upstreamThroughputBps = 7;
  double downstreamThroughputBps = 8;
  double throughputBps = 9;
}

message DataTransmissionMetricSearchResponse {
  repeated DataTransmissionMetricResponse responses = 1;
}

// Throughput Metric
message ThroughputMetricResponse {
  HttpMetricMetadata metadata = 1;
  double totalDataTransmissionTimeInMilliseconds = 2;
  RequestsRate requestsRate = 3;
  RequestsRate requestsRatePerCoolDownPeriod = 4;
  int32 requestsCount = 5;
  int32 activeRequestsCount = 6;
  int32 successfulRequestCount = 7;
  int32 failedRequestsCount = 8;
  double errorRate =9;
}

message ThroughputMetricSearchResponse {
  repeated ThroughputMetricResponse responses = 1;
}

// Response Code Metric
message ResponseCodeMetricResponse {
  HttpMetricMetadata metadata = 1;
  repeated HttpResponseSummary summaries = 2;
}

message ResponseCodeMetricSearchResponse {
  repeated ResponseCodeMetricResponse responses = 1;
}

// Unified Metric Query Service
service MetricsQueryService {
  rpc GetDurationMetrics(MetricRequest) returns (DurationMetricSearchResponse);
  rpc GetDataTransmissionMetrics(MetricRequest) returns (DataTransmissionMetricSearchResponse);
  rpc GetThroughputMetrics(MetricRequest) returns (ThroughputMetricSearchResponse);
  rpc GetResponseCodeMetrics(MetricRequest) returns (ResponseCodeMetricSearchResponse);
}